datasource db {
    provider = "postgresql"
}

generator client {
    provider = "prisma-client"
    output   = "../src/generated"
}

model School {
    id          String  @id @default(uuid())
    name        String  @unique
    address     String?
    phoneNumber String? @map("phone_number")

    users      User[]
    classrooms Classroom[]

    createdAt DateTime @default(now()) @map("created_at")
    updatedAt DateTime @updatedAt @map("updated_at")

    @@map("schools")
}

model User {
    id       String @id @default(uuid())
    email    String @unique
    password String

    role Role @default(STUDENT)

    firstName   String  @map("first_name")
    lastName    String  @map("last_name")
    phoneNumber String? @map("phone_number")
    studentId   String? @map("student_id")
    teacherId   String? @map("teacher_id")

    points Int     @default(0)
    major  String?

    schoolId String @map("school_id")
    school   School @relation(fields: [schoolId], references: [id])

    inventory         UserItem[]
    enrollments       ClassroomOnUser[]
    createAssignments Assignment[]      @relation("AssignmentCreator")

    createdGames Game[]               @relation("GameCreator")
    hostedTutors Tutor[]              @relation("TutorHost")
    submissions  HomeworkSubmission[]

    attendances       Attendance[]
    createdCharacters Character[]

    createdAt          DateTime            @default(now()) @map("created_at")
    updatedAt          DateTime            @updatedAt @map("updated_at")
    classroomAnnounces ClassroomAnnounce[]

    @@map("users")
}

model Classroom {
    id         String  @id @default(uuid())
    name       String
    code       String  @unique
    hoverImage String? @map("hover_image")
    filePdf    String? @map("file_pdf")
    announce   String?
    title      String?
    schoolId   String  @map("school_id")
    school     School  @relation(fields: [schoolId], references: [id])

    users ClassroomOnUser[]

    announces         ClassroomAnnounce[]
    activeGames       ClassroomOnGame[]
    activeTutors      ClassroomOnTutor[]
    activeAssignments ClassroomOnAssignment[]

    createdAt DateTime @default(now()) @map("created_at")
    updatedAt DateTime @updatedAt @map("updated_at")

    @@map("classrooms")
}

model ClassroomAnnounce {
    id      String  @id @default(uuid())
    title   String?
    message String
    filePdf String? @map("file_pdf")

    classroomId String    @map("classroom_id")
    classroom   Classroom @relation(fields: [classroomId], references: [id], onDelete: Cascade)

    creatorId String @map("creator_id")
    creator   User   @relation(fields: [creatorId], references: [id])

    createdAt DateTime @default(now()) @map("created_at")

    @@map("classroom_announces")
}

model ClassroomOnUser {
    userId      String
    classroomId String
    user        User      @relation(fields: [userId], references: [id])
    classroom   Classroom @relation(fields: [classroomId], references: [id], onDelete: Cascade)
    score       Int       @default(0)

    @@id([userId, classroomId])
    @@map("classroom_users")
}

model Game {
    id          String  @id @default(uuid())
    name        String
    imageUrl    String? @map("image_url")
    description String?
    isActive    Boolean @default(true)

    creatorId String? @map("creator_id")
    creator   User?   @relation("GameCreator", fields: [creatorId], references: [id])

    items       GameOnItem[]
    classrooms  ClassroomOnGame[]
    characterId String?           @map("character_id")
    character   Character?        @relation(fields: [characterId], references: [id])

    createdAt DateTime @default(now()) @map("created_at")
    updatedAt DateTime @updatedAt @map("updated_at")

    @@map("game_sessions")
}

model Character {
    id          String  @id @default(uuid())
    bossName    String  @map("boss_name")
    maxHp       Int     @map("max_hp")
    timeLimit   Int     @map("time_limit")
    description String?
    modelUrl    String? @map("model_url")
    imageUrl    String? @map("image_url")

    game Game[]

    creatorId String @map("creator_id")
    creator   User   @relation(fields: [creatorId], references: [id])

    createdAt DateTime @default(now()) @map("created_at")
    updatedAt DateTime @updatedAt @map("updated_at")

    @@map("characters")
}

model ClassroomOnGame {
    id        String  @id @default(uuid())
    isActive  Boolean @default(true)
    currentHp Int     @map("current_hp")

    classroomId String    @map("classroom_id")
    classroom   Classroom @relation(fields: [classroomId], references: [id], onDelete: Cascade)

    gameId String @map("game_id")
    game   Game   @relation(fields: [gameId], references: [id])

    attendances Attendance[]

    @@unique([classroomId, gameId])
    @@map("classroom_games")
}

model Tutor {
    id               String   @id @default(uuid())
    topic            String?
    summary          String?
    dataContent      Json     @map("data_content")
    discordChannelId String   @map("discord_channel_id")
    botLink          String?  @map("bot_link")
    startTime        DateTime @default(now()) @map("start_time")

    hostId String @map("host_id")
    host   User   @relation("TutorHost", fields: [hostId], references: [id])

    classroomSessions ClassroomOnTutor[]

    createdAt DateTime @default(now()) @map("created_at")

    @@map("tutor_sessions")
}

model ClassroomOnTutor {
    id          String    @id @default(uuid())
    classroomId String    @map("classroom_id")
    classroom   Classroom @relation(fields: [classroomId], references: [id], onDelete: Cascade)
    tutorId     String    @map("tutor_id")
    tutor       Tutor     @relation(fields: [tutorId], references: [id])

    startTime DateTime @default(now()) @map("start_time")

    attendances Attendance[]

    @@map("classroom_tutors")
}

model Assignment {
    id    String @id @default(uuid())
    title String @default("Untitled Assignment")

    chatHistory Json?   @map("chat_history")
    filePdf     String? @map("file_pdf")
    textContent String? @map("text_content")

    generatedContent String? @map("generated_content")
    generatedFileTxt String? @map("generated_file_txt")

    gradingCriteria String? @map("grading_criteria")

    status AssignmentStatus @default(DRAFT)

    classrooms ClassroomOnAssignment[]
    creatorId  String?                 @map("creator_id")
    creator    User?                   @relation("AssignmentCreator", fields: [creatorId], references: [id])

    createdAt DateTime @default(now()) @map("created_at")
    updatedAt DateTime @updatedAt @map("updated_at")

    @@map("assignments")
}

model ClassroomOnAssignment {
    id      String   @id @default(uuid())
    dueDate DateTime @map("due_date")

    classroomId  String     @map("classroom_id")
    classroom    Classroom  @relation(fields: [classroomId], references: [id], onDelete: Cascade)
    assignmentId String     @map("assignment_id")
    assignment   Assignment @relation(fields: [assignmentId], references: [id])

    submissions HomeworkSubmission[]

    @@map("classroom_assignments")
}

model HomeworkSubmission {
    id String @id @default(uuid())

    isApproved  Boolean  @default(false) @map("is_approved")
    submittedAt DateTime @default(now()) @map("submitted_at")

    transcription String?

    aiFeedback String? @map("ai_feedback")
    score      Int?    @default(0)

    classroomAssignmentId String                @map("assignment_id")
    classroomAssignment   ClassroomOnAssignment @relation(fields: [classroomAssignmentId], references: [id])

    userId String @map("user_id")
    user   User   @relation(fields: [userId], references: [id])

    attendances Attendance[]

    updatedAt DateTime @updatedAt @map("updated_at")

    @@map("homework_submissions")
}

model Item {
    id          String   @id @default(uuid())
    name        String
    description String?
    price       Int
    effectValue Int      @map("effect_value")
    type        ItemType

    games     GameOnItem[]
    userItems UserItem[]

    @@map("items")
}

model GameOnItem {
    gameId String @map("game_id")
    itemId String @map("item_id")
    game   Game   @relation(fields: [gameId], references: [id])
    item   Item   @relation(fields: [itemId], references: [id])

    createdAt DateTime @default(now()) @map("created_at")
    updatedAt DateTime @updatedAt @map("updated_at")

    @@id([gameId, itemId])
    @@map("game_items")
}

model UserItem {
    id     String @id @default(uuid())
    amount Int    @default(1)

    userId String @map("user_id")
    user   User   @relation(fields: [userId], references: [id])

    itemId String @map("item_id")
    item   Item   @relation(fields: [itemId], references: [id])

    @@unique([userId, itemId], name: "user_item_unique")
    @@map("user_items")
}

model Attendance {
    id          String      @id @default(uuid())
    scoreEarned Int         @default(0)
    damageDealt Int         @default(0) @map("damage_dealt")
    status      CheckStatus @default(PRESENT)
    createdAt   DateTime    @default(now()) @map("created_at")

    userId String @map("user_id")
    user   User   @relation(fields: [userId], references: [id])

    activeGameId String?          @map("active_game_id")
    activeGame   ClassroomOnGame? @relation(fields: [activeGameId], references: [id])

    activeTutorId String?           @map("active_tutor_id")
    activeTutor   ClassroomOnTutor? @relation(fields: [activeTutorId], references: [id])

    homeworkSubmissionId String?             @map("homework_submission_id")
    homeworkSubmission   HomeworkSubmission? @relation(fields: [homeworkSubmissionId], references: [id])

    @@unique([userId, activeGameId])
    @@unique([userId, activeTutorId])
    @@unique([userId, homeworkSubmissionId])
    @@map("attendances")
}

enum Role {
    ADMIN
    TEACHER
    STUDENT
}

enum AssignmentStatus {
    DRAFT
    PUBLISHED
    ARCHIVED
}

enum CheckStatus {
    PRESENT
    LATE
    ABSENT
}

enum ItemType {
    ATTACK_BOOST
    TIME_EXTEND
}
