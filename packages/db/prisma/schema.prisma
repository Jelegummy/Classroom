datasource db {
    provider = "postgresql"
}

generator client {
    provider = "prisma-client"
    output   = "../src/generated"
}

model School {
    id          String  @id @default(uuid())
    name        String  @unique
    address     String?
    phoneNumber String? @map("phone_number")

    users      User[]
    classrooms Classroom[]

    createdAt DateTime @default(now()) @map("created_at")
    updatedAt DateTime @updatedAt @map("updated_at")

    @@map("schools")
}

model User {
    id       String @id @default(uuid())
    email    String @unique
    password String

    role Role @default(STUDENT)

    firstName   String  @map("first_name")
    lastName    String  @map("last_name")
    phoneNumber String? @map("phone_number")
    studentId   String? @map("student_id")
    teacherId   String? @map("teacher_id")

    points         Int     @default(0)
    major          String?
    graduationYear Int?    @map("graduation_year")

    schoolId String @map("school_id")
    school   School @relation(fields: [schoolId], references: [id])

    inventory         UserItem[]
    enrollments       ClassroomOnUser[]
    createAssignments Assignment[]      @relation("AssignmentCreator")

    createdGames GameSession[]        @relation("GameCreator")
    hostedTutors TutorSession[]       @relation("TutorHost")
    submissions  HomeworkSubmission[]

    attendances Attendance[]

    createdAt DateTime @default(now()) @map("created_at")
    updatedAt DateTime @updatedAt @map("updated_at")

    @@map("users")
}

model Classroom {
    id         String  @id @default(uuid())
    name       String
    code       String  @unique
    hoverImage String? @map("hover_image")
    schoolId   String  @map("school_id")
    school     School  @relation(fields: [schoolId], references: [id])

    users ClassroomOnUser[]

    games       GameSession[]
    tutors      TutorSession[]
    assignments Assignment[]

    createdAt DateTime @default(now()) @map("created_at")
    updatedAt DateTime @updatedAt @map("updated_at")

    @@map("classrooms")
}

model ClassroomOnUser {
    userId      String
    classroomId String
    user        User      @relation(fields: [userId], references: [id])
    classroom   Classroom @relation(fields: [classroomId], references: [id])

    @@id([userId, classroomId])
    @@map("classroom_users")
}

model GameSession {
    id          String  @id @default(uuid())
    name        String
    bossName    String  @map("boss_name")
    imageUrl    String? @map("image_url")
    maxHp       Int     @map("max_hp")
    currentHp   Int     @map("current_hp")
    timeLimit   Int     @map("time_limit")
    description String?
    isActive    Boolean @default(true)

    classroomId String    @map("classroom_id")
    classroom   Classroom @relation(fields: [classroomId], references: [id])

    creatorId String? @map("creator_id")
    creator   User?   @relation("GameCreator", fields: [creatorId], references: [id])

    attendances Attendance[]

    createdAt DateTime @default(now()) @map("created_at")
    updatedAt DateTime @updatedAt @map("updated_at")

    @@map("game_sessions")
}

model TutorSession {
    id               String   @id @default(uuid())
    topic            String?
    summary          String?
    dataContent      Json     @map("data_content")
    discordChannelId String   @map("discord_channel_id")
    botLink          String?  @map("bot_link")
    startTime        DateTime @default(now()) @map("start_time")

    hostId String @map("host_id")
    host   User   @relation("TutorHost", fields: [hostId], references: [id])

    classroomId String    @map("classroom_id")
    classroom   Classroom @relation(fields: [classroomId], references: [id])

    attendances Attendance[]

    createdAt DateTime @default(now()) @map("created_at")

    @@map("tutor_sessions")
}

model Assignment {
    id    String @id @default(uuid())
    title String @default("Untitled Assignment")

    chatHistory Json?   @map("chat_history")
    filePdf     String? @map("file_pdf")
    textContent String? @map("text_content")

    generatedContent String? @map("generated_content")
    generatedFileTxt String? @map("generated_file_txt")

    gradingCriteria String? @map("grading_criteria")

    status AssignmentStatus @default(DRAFT)

    classroomId String    @map("classroom_id")
    classroom   Classroom @relation(fields: [classroomId], references: [id])
    creatorId   String?   @map("creator_id")
    creator     User?     @relation("AssignmentCreator", fields: [creatorId], references: [id])

    submissions HomeworkSubmission[]

    createdAt DateTime @default(now()) @map("created_at")
    updatedAt DateTime @updatedAt @map("updated_at")

    @@map("assignments")
}

model HomeworkSubmission {
    id String @id @default(uuid())

    isApproved  Boolean  @default(false) @map("is_approved")
    submittedAt DateTime @default(now()) @map("submitted_at")

    transcription String?

    aiFeedback String? @map("ai_feedback")
    score      Int?    @default(0)

    assignmentId String     @map("assignment_id")
    assignment   Assignment @relation(fields: [assignmentId], references: [id])

    userId String @map("user_id")
    user   User   @relation(fields: [userId], references: [id])

    attendances Attendance[]

    updatedAt DateTime @updatedAt @map("updated_at")

    @@map("homework_submissions")
}

model Attendance {
    id          String      @id @default(uuid())
    scoreEarned Int         @default(0)
    damageDealt Int         @default(0)
    status      CheckStatus @default(PRESENT)
    createdAt   DateTime    @default(now()) @map("created_at")

    userId String @map("user_id")
    user   User   @relation(fields: [userId], references: [id])

    gameSessionId String?      @map("game_session_id")
    gameSession   GameSession? @relation(fields: [gameSessionId], references: [id])

    tutorSessionId String?       @map("tutor_session_id")
    tutorSession   TutorSession? @relation(fields: [tutorSessionId], references: [id])

    homeworkSubmissionId String?             @map("homework_submission_id")
    homeworkSubmission   HomeworkSubmission? @relation(fields: [homeworkSubmissionId], references: [id])

    @@unique([userId, gameSessionId])
    @@unique([userId, tutorSessionId])
    @@unique([userId, homeworkSubmissionId])
    @@map("attendances")
}

model Item {
    id          String  @id @default(uuid())
    name        String
    description String?
    price       Int
    effectValue Int     @map("effect_value")

    type      ItemType
    userItems UserItem[]

    @@map("items")
}

model UserItem {
    id     String @id @default(uuid())
    amount Int    @default(1)

    userId String @map("user_id")
    user   User   @relation(fields: [userId], references: [id])

    itemId String @map("item_id")
    item   Item   @relation(fields: [itemId], references: [id])

    @@map("user_items")
}

enum Role {
    ADMIN
    TEACHER
    STUDENT
}

enum AssignmentStatus {
    DRAFT
    PUBLISHED
    ARCHIVED
}

enum CheckStatus {
    PRESENT
    LATE
    ABSENT
}

enum ItemType {
    ATTACK_BOOST
    TIME_EXTEND
}
